create table filter
table ip filter {
	chain input {
		type filter hook input priority 0; policy drop;
		jump ct-icmp

		iif lo counter accept comment "BGP unnumbered"
		iif lan0 ip saddr 10.0.0.0/8 udp dport 4789 counter accept comment "incoming vxlan lan0"
		iif lan1 ip saddr 10.0.0.0/8 udp dport 4789 counter accept comment "incoming vxlan lan1"
		ct state new tcp dport 22 counter accept comment "incoming ssh"

		goto refuse
	}
	chain forward {
		type filter hook forward priority 0; policy drop;
		jump ct-icmp

		# dynamic ingress rules
		ip saddr { 192.168.0.0/24, 192.168.2.0/24 } ip daddr 212.37.83.1 tcp dport { 80, 53 } counter accept comment "accept traffic for k8s service test-ns/s1"
		ip saddr { 212.1.1.1/32 } ip daddr 212.37.83.2 tcp dport { 443 } counter accept comment "accept traffic for k8s service test-ns/s2"

		# dynamic egress rules
		ip daddr { 1.1.1.1/32, 1.0.0.1/32 } tcp dport { 53 } counter accept comment "accept traffic for np np-egress-dns"
		ip daddr { 1.1.1.1/32, 1.0.0.1/32 } udp dport { 53 } counter accept comment "accept traffic for np np-egress-dns"
		ip daddr { 162.159.200.1/32 } udp dport { 123 } counter accept comment "accept traffic for np np-egress-ntp"

		goto refuse
	}
	chain output {
		type filter hook output priority 0; policy drop;
		jump ct-icmp

		iif lo counter accept comment "accept output required e.g. for chrony"

		goto refuse
	}
	chain ct-icmp {
		# state dependent rules
		ct state established,related counter accept comment "accept established connections"
		ct state invalid counter drop comment "drop packets with invalid ct state"

		# no ping floods
		ip protocol icmp icmp type echo-request limit rate over 10/second burst 4 packets counter drop comment "drop ping floods"

		# ICMP
		ip protocol icmp icmp type { destination-unreachable, router-solicitation, router-advertisement, time-exceeded, parameter-problem } counter accept comment "accept icmp"
	}
	chain refuse {
		counter comment "count dropped packets"
		limit rate 2/minute counter packets 1 bytes 40 log prefix "nftables-dropped: "
	}
}
table ip nat {
    chain postrouting {
        type nat hook postrouting priority 0; policy accept;
        oifname "vlan104009" ip saddr 10.3.116.0/22 counter masquerade comment "snat (networkid: internet-nbg-w8101)"
    }
}