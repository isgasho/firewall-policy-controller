create table mf
table ip mf {
	chain mf-input {
		type filter hook input priority 0;
		policy drop

		jump mf-ct-icmp

		iif lo accept comment "BGP unnumbered"
		iif lan0 ip saddr 10.0.0.0/8 udp dport 4789 accept comment "incoming vxlan lan0"
		iif lan1 ip saddr 10.0.0.0/8 udp dport 4789 accept comment "incoming vxlan lan1"
		ct state new tcp dport 22 accept comment "incoming ssh"

		goto mf-final
	}
	chain mf-forward {
		type filter hook forward priority 0;
		policy drop

		jump mf-ct-icmp

		# dynamic ingress rules
		ip saddr != { 192.168.1.0/24, 192.168.2.0/24, 10.0.1.1/32 } ip saddr { 192.168.0.0/16, 10.0.0.0/16 } ip daddr 212.37.83.1 tcp dport { 80 } accept comment "accept traffic for k8s service test-ns/s1"
		ip saddr != { 192.168.1.0/24, 192.168.2.0/24, 10.0.1.1/32 } ip saddr { 192.168.0.0/16, 10.0.0.0/16 } ip daddr 212.37.83.1 udp dport { 53 } accept comment "accept traffic for k8s service test-ns/s1"
		ip saddr { 212.1.1.1/32 } ip daddr 212.37.83.2 tcp dport { 443 } accept comment "accept traffic for k8s service test-ns/s2"

		# dynamic egress rules
		ip daddr { 1.1.1.1/32, 1.0.0.1/32 } tcp dport { 53 } accept comment "accept traffic for np np-egress-dns"
		ip daddr { 1.1.1.1/32, 1.0.0.1/32 } udp dport { 53 } accept comment "accept traffic for np np-egress-dns"
		ip daddr { 162.159.200.1/32 } udp dport { 123 } accept comment "accept traffic for np np-egress-ntp"

		goto mf-final
	}
	chain mf-ct-output {
		type filter hook input priority 0;
		policy drop

		jump mf-ct-icmp

		iif lo accept comment "accept output required e.g. for chrony"

		goto mf-final
	}
	chain mf-ct-icmp {
		# state dependent rules
		ct state established,related accept comment "accept established connections"
		ct state invalid drop comment "drop packets with invalid ct state"

		# no ping floods
		ip protocol icmp icmp type echo-request limit rate over 10/second burst 4 packets drop comment "drop ping floods"

		# ICMP & IGMP
		ip protocol icmp icmp type { destination-unreachable, router-solicitation, router-advertisement, time-exceeded, parameter-problem } accept comment "accept icmp"
		ip protocol igmp accept comment "accept igmp"

		goto mf-final
	}
	chain mf-final {
		counter comment "count dropped packets"
		log prefix "dropped: "
	}
}
